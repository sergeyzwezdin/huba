name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: biomejs/setup-biome@v2.7.0
        with:
          version: "2.4.4"

      - run: biome ci .

  build:
    name: Build (${{ matrix.target }})
    needs: check
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - runner: ubuntu-24.04
            target: linux-x64
            script: build:linux-x64
            artifact: hb-linux-x64

          - runner: ubuntu-24.04-arm
            target: linux-arm64
            script: build:linux-arm64
            artifact: hb-linux-arm64

          - runner: macos-15-intel
            target: darwin-x64
            script: build:darwin-x64
            artifact: hb-darwin-x64

          - runner: macos-15
            target: darwin-arm64
            script: build:darwin-arm64
            artifact: hb-darwin-arm64

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: oven-sh/setup-bun@v2

      - run: bun install --frozen-lockfile

      - run: bun run ${{ matrix.script }}

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: |
            .bin/${{ matrix.artifact }}

  release:
    name: Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      models: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read version from package.json
        id: version
        run: echo "VERSION=$(jq -r .version package.json)" >> $GITHUB_OUTPUT

      - name: Check if release already exists
        id: check
        run: |
          if gh release view "${{ steps.version.outputs.VERSION }}" &>/dev/null; then
            echo "EXISTS=true" >> $GITHUB_OUTPUT
          else
            echo "EXISTS=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Find previous release
        if: steps.check.outputs.EXISTS == 'false'
        id: prev
        run: |
          PREV_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName // empty')
          echo "TAG=${PREV_TAG}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Generate diff for release notes
        if: steps.check.outputs.EXISTS == 'false'
        id: diff
        run: |
          if [ -n "${{ steps.prev.outputs.TAG }}" ]; then
            DIFF=$(git diff "${{ steps.prev.outputs.TAG }}"..HEAD --stat && echo "---" && git log "${{ steps.prev.outputs.TAG }}"..HEAD --pretty=format:"%h %s")
          else
            FIRST_COMMIT=$(git rev-list --max-parents=0 HEAD)
            DIFF=$(git diff "${FIRST_COMMIT}"..HEAD --stat && echo "---" && git log "${FIRST_COMMIT}"..HEAD --pretty=format:"%h %s")
          fi
          EOF_MARKER=$(dd if=/dev/urandom bs=15 count=1 2>/dev/null | base64)
          echo "DIFF<<${EOF_MARKER}" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "${EOF_MARKER}" >> $GITHUB_OUTPUT

      - name: Generate release notes with AI
        if: steps.check.outputs.EXISTS == 'false'
        id: notes
        uses: actions/ai-inference@v1
        with:
          prompt: |
            You are writing release notes for version ${{ steps.version.outputs.VERSION }} of "huba" — a slick TUI for managing Claude Code tasks.
            Below is the diff summary and commit log since the previous release (${{ steps.prev.outputs.TAG || 'initial' }}):

            ${{ steps.diff.outputs.DIFF }}

            Write concise, user-facing release notes in markdown. Group changes into sections like "New Features", "Improvements", "Bug Fixes" as appropriate. Only include sections that have changes. Do not include the version number as a heading. Do not include raw commit hashes.

            Style guide — match the project's voice:
            - Casual, punchy, developer-first tone. Talk to the reader directly ("you", not "users").
            - Short sentences. Em dashes for asides — like this.
            - Bold key terms for scannability.
            - Be specific about what changed. No filler, no corporate fluff, no "we're excited to announce".
            - Keep it fun but informative — think changelog meets dev blog, not press release.
            - Use active voice and imperative mood where it fits ("Browse tasks", not "Tasks can now be browsed").

      - name: Download all artifacts
        if: steps.check.outputs.EXISTS == 'false'
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Package tarballs
        if: steps.check.outputs.EXISTS == 'false'
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          mkdir -p release

          for pair in "hb-darwin-arm64:darwin-arm64" "hb-darwin-x64:darwin-amd64" "hb-linux-x64:linux-amd64" "hb-linux-arm64:linux-arm64"; do
            artifact="${pair%%:*}"
            target="${pair##*:}"
            cp "artifacts/${artifact}/${artifact}" hb
            chmod +x hb
            tar -czf "release/huba-${target}-${VERSION}.tar.gz" hb
            rm hb
          done

      - name: Create release and upload binaries
        if: steps.check.outputs.EXISTS == 'false'
        run: |
          gh release create "${{ steps.version.outputs.VERSION }}" \
            --title "${{ steps.version.outputs.VERSION }}" \
            --latest \
            --notes-file <(cat "${{ steps.notes.outputs.response-file }}") \
            release/*
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Delete build artifacts
        if: always()
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            hb-linux-x64
            hb-linux-arm64
            hb-darwin-x64
            hb-darwin-arm64
